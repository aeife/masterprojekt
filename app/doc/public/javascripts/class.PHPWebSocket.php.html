<!DOCTYPE html>
<html>
<head>
  <title>class.PHPWebSocket.php</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = '../../', thisFile = 'public/javascripts/class.PHPWebSocket.php', defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>class.PHPWebSocket.php</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="cp">&lt;?php</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Based on PHP WebSocket Server 0.2
- <a href='http://code.google.com/p/php-websocket-server/'>http://code.google.com/p/php-websocket-server/</a>
- <a href='http://code.google.com/p/php-websocket-server/wiki/Scripting'>http://code.google.com/p/php-websocket-server/wiki/Scripting</a></p>
  </div>
  <div class="body"><p>WebSocket Protocol 07
- <a href='http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-07'>http://tools.ietf.org/html/draft-ietf-hybi-thewebsocketprotocol-07</a>
- Supported by Firefox 6 (30/08/2011)</p>

<p>Whilst a big effort is made to follow the protocol documentation, the current script version may unknowingly differ.
Please report any bugs you may find, all feedback and questions are welcome!</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="nb">date_default_timezone_set</span><span class="p">(</span><span class="s1">&#39;UTC&#39;</span><span class="p">);</span>

<span class="k">class</span> <span class="nc">PHPWebSocket</span>
<span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>maximum amount of clients that can be connected at one time</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>  <span class="k">const</span> <span class="no">WS_MAX_CLIENTS</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>maximum amount of clients that can be connected at one time on the same IP v4 address</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>  <span class="k">const</span> <span class="no">WS_MAX_CLIENTS_PER_IP</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>amount of seconds a client has to send data to the server, before a ping request is sent to the client,
if the client has not completed the opening handshake, the ping request is skipped and the client connection is closed</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>  <span class="k">const</span> <span class="no">WS_TIMEOUT_RECV</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>amount of seconds a client has to reply to a ping request, before the client connection is closed</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>  <span class="k">const</span> <span class="no">WS_TIMEOUT_PONG</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>the maximum length, in bytes, of a frame's payload data (a message consists of 1 or more frames), this is also internally limited to 2,147,479,538</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>  <span class="k">const</span> <span class="no">WS_MAX_FRAME_PAYLOAD_RECV</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>the maximum length, in bytes, of a message's payload data, this is also internally limited to 2,147,483,647</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>  <span class="k">const</span> <span class="no">WS_MAX_MESSAGE_PAYLOAD_RECV</span> <span class="o">=</span> <span class="mi">500000</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>internal</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>  <span class="k">const</span> <span class="no">WS_FIN</span> <span class="o">=</span>  <span class="mi">128</span><span class="p">;</span>
  <span class="k">const</span> <span class="no">WS_MASK</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>

  <span class="k">const</span> <span class="no">WS_OPCODE_CONTINUATION</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">const</span> <span class="no">WS_OPCODE_TEXT</span> <span class="o">=</span>         <span class="mi">1</span><span class="p">;</span>
  <span class="k">const</span> <span class="no">WS_OPCODE_BINARY</span> <span class="o">=</span>       <span class="mi">2</span><span class="p">;</span>
  <span class="k">const</span> <span class="no">WS_OPCODE_CLOSE</span> <span class="o">=</span>        <span class="mi">8</span><span class="p">;</span>
  <span class="k">const</span> <span class="no">WS_OPCODE_PING</span> <span class="o">=</span>         <span class="mi">9</span><span class="p">;</span>
  <span class="k">const</span> <span class="no">WS_OPCODE_PONG</span> <span class="o">=</span>         <span class="mi">10</span><span class="p">;</span>

  <span class="k">const</span> <span class="no">WS_PAYLOAD_LENGTH_16</span> <span class="o">=</span> <span class="mi">126</span><span class="p">;</span>
  <span class="k">const</span> <span class="no">WS_PAYLOAD_LENGTH_63</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>

  <span class="k">const</span> <span class="no">WS_READY_STATE_CONNECTING</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">const</span> <span class="no">WS_READY_STATE_OPEN</span> <span class="o">=</span>       <span class="mi">1</span><span class="p">;</span>
  <span class="k">const</span> <span class="no">WS_READY_STATE_CLOSING</span> <span class="o">=</span>    <span class="mi">2</span><span class="p">;</span>
  <span class="k">const</span> <span class="no">WS_READY_STATE_CLOSED</span> <span class="o">=</span>     <span class="mi">3</span><span class="p">;</span>

  <span class="k">const</span> <span class="no">WS_STATUS_NORMAL_CLOSE</span> <span class="o">=</span>             <span class="mi">1000</span><span class="p">;</span>
  <span class="k">const</span> <span class="no">WS_STATUS_GONE_AWAY</span> <span class="o">=</span>                <span class="mi">1001</span><span class="p">;</span>
  <span class="k">const</span> <span class="no">WS_STATUS_PROTOCOL_ERROR</span> <span class="o">=</span>           <span class="mi">1002</span><span class="p">;</span>
  <span class="k">const</span> <span class="no">WS_STATUS_UNSUPPORTED_MESSAGE_TYPE</span> <span class="o">=</span> <span class="mi">1003</span><span class="p">;</span>
  <span class="k">const</span> <span class="no">WS_STATUS_MESSAGE_TOO_BIG</span> <span class="o">=</span>          <span class="mi">1004</span><span class="p">;</span>

  <span class="k">const</span> <span class="no">WS_STATUS_TIMEOUT</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>global vars</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>  <span class="k">public</span> <span class="nv">$wsClients</span>       <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
  <span class="k">public</span> <span class="nv">$wsRead</span>          <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
  <span class="k">public</span> <span class="nv">$wsClientCount</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">public</span> <span class="nv">$wsClientIPCount</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
  <span class="k">public</span> <span class="nv">$wsOnEvents</span>      <span class="o">=</span> <span class="k">array</span><span class="p">();</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>$this->wsClients[ integer ClientID ] = array(
0 => resource  Socket,                            // client socket
1 => string    MessageBuffer,                     // a blank string when there's no incoming frames
2 => integer   ReadyState,                        // between 0 and 3
3 => integer   LastRecvTime,                      // set to time() when the client is added
4 => int/false PingSentTime,                      // false when the server is not waiting for a pong
5 => int/false CloseStatus,                       // close status that wsOnClose() will be called with
6 => integer   IPv4,                              // client's IP stored as a signed long, retrieved from ip2long()
7 => int/false FramePayloadDataLength,            // length of a frame's payload data, reset to false when all frame data has been read (cannot reset to 0, to allow reading of mask key)
8 => integer   FrameBytesRead,                    // amount of bytes read for a frame, reset to 0 when all frame data has been read
9 => string    FrameBuffer,                       // joined onto end as a frame's data comes in, reset to blank string when all frame data has been read
10 => integer  MessageOpcode,                     // stored by the first frame for fragmented messages, default value is 0
11 => integer  MessageBufferLength                // the payload data length of MessageBuffer
)</p>
  </div>
  <div class="body"><p>$wsRead[ integer ClientID ] = resource Socket         // this one-dimensional array is used for socket_select()
// $wsRead[ 0 ] is the socket listening for incoming client connections</p>

<p>$wsClientCount = integer ClientCount                  // amount of clients currently connected</p>

<p>$wsClientIPCount[ integer IP ] = integer ClientCount  // amount of clients connected per IP v4 address</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>server state functions</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>  <span class="k">function</span> <span class="nf">wsStartServer</span><span class="p">(</span><span class="nv">$host</span><span class="p">,</span> <span class="nv">$port</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsRead</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsRead</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">socket_create</span><span class="p">(</span><span class="nx">AF_INET</span><span class="p">,</span> <span class="nx">SOCK_STREAM</span><span class="p">,</span> <span class="nx">SOL_TCP</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">socket_set_option</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsRead</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">SOL_SOCKET</span><span class="p">,</span> <span class="nx">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
      <span class="nb">socket_close</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsRead</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">socket_bind</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsRead</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nv">$host</span><span class="p">,</span> <span class="nv">$port</span><span class="p">))</span> <span class="p">{</span>
      <span class="nb">socket_close</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsRead</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">socket_listen</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsRead</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
      <span class="nb">socket_close</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsRead</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nv">$write</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="nv">$except</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

    <span class="nv">$nextPingCheck</span> <span class="o">=</span> <span class="nb">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsRead</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
      <span class="nv">$changed</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsRead</span><span class="p">;</span>
      <span class="nv">$result</span> <span class="o">=</span> <span class="nb">socket_select</span><span class="p">(</span><span class="nv">$changed</span><span class="p">,</span> <span class="nv">$write</span><span class="p">,</span> <span class="nv">$except</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">socket_close</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsRead</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">elseif</span> <span class="p">(</span><span class="nv">$result</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$changed</span> <span class="k">as</span> <span class="nv">$clientID</span> <span class="o">=&gt;</span> <span class="nv">$socket</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nv">$clientID</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>client socket changed</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="nv">$buffer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
            <span class="nv">$bytes</span> <span class="o">=</span> <span class="o">@</span><span class="nb">socket_recv</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="nv">$buffer</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nv">$bytes</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>error on recv, remove client socket (will check to send close frame)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>              <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsSendClientClose</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_STATUS_PROTOCOL_ERROR</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">elseif</span> <span class="p">(</span><span class="nv">$bytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>process handshake or frame(s)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>              <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsProcessClient</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nv">$buffer</span><span class="p">,</span> <span class="nv">$bytes</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsSendClientClose</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_STATUS_PROTOCOL_ERROR</span><span class="p">);</span>
              <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<p>0 bytes received from client, meaning the client closed the TCP connection</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>              <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsRemoveClient</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>listen socket changed</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="nv">$client</span> <span class="o">=</span> <span class="nb">socket_accept</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsRead</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$client</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>fetch client IP as integer</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>              <span class="nv">$clientIP</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
              <span class="nv">$result</span> <span class="o">=</span> <span class="nb">socket_getpeername</span><span class="p">(</span><span class="nv">$client</span><span class="p">,</span> <span class="nv">$clientIP</span><span class="p">);</span>
              <span class="nv">$clientIP</span> <span class="o">=</span> <span class="nx">ip2long</span><span class="p">(</span><span class="nv">$clientIP</span><span class="p">);</span>

              <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span> <span class="o">!==</span> <span class="k">false</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClientCount</span> <span class="o">&lt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_MAX_CLIENTS</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClientIPCount</span><span class="p">[</span><span class="nv">$clientIP</span><span class="p">])</span> <span class="o">||</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClientIPCount</span><span class="p">[</span><span class="nv">$clientIP</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_MAX_CLIENTS_PER_IP</span><span class="p">))</span> <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsAddClient</span><span class="p">(</span><span class="nv">$client</span><span class="p">,</span> <span class="nv">$clientIP</span><span class="p">);</span>
              <span class="p">}</span>
              <span class="k">else</span> <span class="p">{</span>
                <span class="nb">socket_close</span><span class="p">(</span><span class="nv">$client</span><span class="p">);</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nb">time</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="nv">$nextPingCheck</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsCheckIdleClients</span><span class="p">();</span>
        <span class="nv">$nextPingCheck</span> <span class="o">=</span> <span class="nb">time</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">true</span><span class="p">;</span> <span class="c1">// returned when wsStopServer() is called</span>
  <span class="p">}</span>
  <span class="k">function</span> <span class="nf">wsStopServer</span><span class="p">()</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>check if server is not running</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsRead</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<p>close all client connections</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span> <span class="k">as</span> <span class="nv">$clientID</span> <span class="o">=&gt;</span> <span class="nv">$client</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>if the client's opening handshake is complete, tell the client the server is 'going away'</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nv">$client</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_READY_STATE_CONNECTING</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsSendClientClose</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_STATUS_GONE_AWAY</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nb">socket_close</span><span class="p">(</span><span class="nv">$client</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>close the socket which listens for incoming clients</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nb">socket_close</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsRead</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>reset variables</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsRead</span>          <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span>       <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClientCount</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClientIPCount</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
  <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>client timeout functions</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>  <span class="k">function</span> <span class="nf">wsCheckIdleClients</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$time</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span> <span class="k">as</span> <span class="nv">$clientID</span> <span class="o">=&gt;</span> <span class="nv">$client</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$client</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_READY_STATE_CLOSED</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>client ready state is not closed</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nv">$client</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>ping request has already been sent to client, pending a pong reply</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span><span class="nv">$time</span> <span class="o">&gt;=</span> <span class="nv">$client</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_TIMEOUT_PONG</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>client didn't respond to the server's ping request in self::WS_TIMEOUT_PONG seconds</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsSendClientClose</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_STATUS_TIMEOUT</span><span class="p">);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsRemoveClient</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">elseif</span> <span class="p">(</span><span class="nv">$time</span> <span class="o">&gt;=</span> <span class="nv">$client</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_TIMEOUT_RECV</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>
<p>last data was received >= self::WS_TIMEOUT_RECV seconds ago</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span><span class="nv">$client</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_READY_STATE_CONNECTING</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>client ready state is open or closing</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsSendClientMessage</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_OPCODE_PING</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="k">else</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>client ready state is connecting</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsRemoveClient</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>client existence functions</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>  <span class="k">function</span> <span class="nf">wsAddClient</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="nv">$clientIP</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>increase amount of clients connected</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClientCount</span><span class="o">++</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<p>increase amount of clients connected on this client's IP</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClientIPCount</span><span class="p">[</span><span class="nv">$clientIP</span><span class="p">]))</span> <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClientIPCount</span><span class="p">[</span><span class="nv">$clientIP</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClientIPCount</span><span class="p">[</span><span class="nv">$clientIP</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<p>fetch next client ID</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$clientID</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsGetNextClientID</span><span class="p">();</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>store initial client data</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_READY_STATE_CONNECTING</span><span class="p">,</span> <span class="nb">time</span><span class="p">(),</span> <span class="k">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$clientIP</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>store socket - used for socket_select()</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsRead</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$socket</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">function</span> <span class="nf">wsRemoveClient</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<p>fetch close status (which could be false), and call wsOnClose</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$closeStatus</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">5</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsOnEvents</span><span class="p">)</span> <span class="p">)</span>
      <span class="k">foreach</span> <span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsOnEvents</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$func</span> <span class="p">)</span>
        <span class="nv">$func</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nv">$closeStatus</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38">&#182;</a>
</div>
<p>close socket</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$socket</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
    <span class="nb">socket_close</span><span class="p">(</span><span class="nv">$socket</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<p>decrease amount of clients connected on this client's IP</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$clientIP</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">6</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClientIPCount</span><span class="p">[</span><span class="nv">$clientIP</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClientIPCount</span><span class="p">[</span><span class="nv">$clientIP</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nb">unset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClientIPCount</span><span class="p">[</span><span class="nv">$clientIP</span><span class="p">]);</span>
    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40">&#182;</a>
</div>
<p>decrease amount of clients connected</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClientCount</span><span class="o">--</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41">&#182;</a>
</div>
<p>remove socket and client data from arrays</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nb">unset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsRead</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">],</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">]);</span>
  <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42">&#182;</a>
</div>
<p>client data functions</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>  <span class="k">function</span> <span class="nf">wsGetNextClientID</span><span class="p">()</span> <span class="p">{</span>
    <span class="nv">$i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// starts at 1 because 0 is the listen socket</span>
    <span class="k">while</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsRead</span><span class="p">[</span><span class="nv">$i</span><span class="p">]))</span> <span class="nv">$i</span><span class="o">++</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$i</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">function</span> <span class="nf">wsGetClientSocket</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
  <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43">&#182;</a>
</div>
<p>client read functions</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>  <span class="k">function</span> <span class="nf">wsProcessClient</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$buffer</span><span class="p">,</span> <span class="nv">$bufferLength</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_READY_STATE_OPEN</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44">&#182;</a>
</div>
<p>handshake completed</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsBuildClientFrame</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nv">$buffer</span><span class="p">,</span> <span class="nv">$bufferLength</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">elseif</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_READY_STATE_CONNECTING</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45">&#182;</a>
</div>
<p>handshake not completed</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsProcessClientHandshake</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nv">$buffer</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$result</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_READY_STATE_OPEN</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsOnEvents</span><span class="p">)</span> <span class="p">)</span>
          <span class="k">foreach</span> <span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsOnEvents</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$func</span> <span class="p">)</span>
            <span class="nv">$func</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46">&#182;</a>
</div>
<p>ready state is set to closed</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="nv">$result</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">function</span> <span class="nf">wsBuildClientFrame</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$buffer</span><span class="p">,</span> <span class="nv">$bufferLength</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47">&#182;</a>
</div>
<p>increase number of bytes read for the frame, and join buffer onto end of the frame buffer</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span> <span class="o">+=</span> <span class="nv">$bufferLength</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span> <span class="o">.=</span> <span class="nv">$buffer</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48">&#182;</a>
</div>
<p>check if the length of the frame's payload data has been fetched, if not then attempt to fetch it from the frame buffer</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">!==</span> <span class="k">false</span> <span class="o">||</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsCheckSizeClientFrame</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">)</span> <span class="o">==</span> <span class="k">true</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49">&#182;</a>
</div>
<p>work out the header length of the frame</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="nv">$headerLength</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">125</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">65535</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">8</span><span class="p">))</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50">&#182;</a>
</div>
<p>check if all bytes have been received for the frame</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="nv">$frameLength</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="nv">$headerLength</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nv">$frameLength</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51">&#182;</a>
</div>
<p>check if too many bytes have been read for the frame (they are part of the next frame)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="nv">$nextFrameBytesLength</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span> <span class="o">-</span> <span class="nv">$frameLength</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$nextFrameBytesLength</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span> <span class="o">-=</span> <span class="nv">$nextFrameBytesLength</span><span class="p">;</span>
          <span class="nv">$nextFrameBytes</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">9</span><span class="p">],</span> <span class="nv">$frameLength</span><span class="p">);</span>
          <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">9</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$frameLength</span><span class="p">);</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-52" id="section-52">&#182;</a>
</div>
<p>process the frame</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsProcessClientFrame</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-53" id="section-53">&#182;</a>
</div>
<p>check if the client wasn't removed, then reset frame data</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">]))</span> <span class="p">{</span>
          <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
          <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-54" id="section-54">&#182;</a>
</div>
<p>if there's no extra bytes for the next frame, or processing the frame failed, return the result of processing the frame</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nv">$nextFrameBytesLength</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="nv">$result</span><span class="p">)</span> <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-55" id="section-55">&#182;</a>
</div>
<p>build the next frame with the extra bytes</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsBuildClientFrame</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nv">$nextFrameBytes</span><span class="p">,</span> <span class="nv">$nextFrameBytesLength</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">function</span> <span class="nf">wsCheckSizeClientFrame</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-56" id="section-56">&#182;</a>
</div>
<p>check if at least 2 bytes have been stored in the frame buffer</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-57" id="section-57">&#182;</a>
</div>
<p>fetch payload length in byte 2, max will be 127</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="nv">$payloadLength</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">9</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">127</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nv">$payloadLength</span> <span class="o">&lt;=</span> <span class="mi">125</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-58" id="section-58">&#182;</a>
</div>
<p>actual payload length is &lt;= 125</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$payloadLength</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">elseif</span> <span class="p">(</span><span class="nv">$payloadLength</span> <span class="o">==</span> <span class="mi">126</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-59" id="section-59">&#182;</a>
</div>
<p>actual payload length is &lt;= 65,535</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">9</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-60" id="section-60">&#182;</a>
</div>
<p>at least another 2 bytes are set</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>          <span class="nv">$payloadLengthExtended</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">9</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
          <span class="nv">$array</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s1">&#39;na&#39;</span><span class="p">,</span> <span class="nv">$payloadLengthExtended</span><span class="p">);</span>
          <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$array</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-61" id="section-61">&#182;</a>
</div>
<p>actual payload length is > 65,535</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">9</span><span class="p">],</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-62" id="section-62">&#182;</a>
</div>
<p>at least another 8 bytes are set</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>          <span class="nv">$payloadLengthExtended</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">9</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-63" id="section-63">&#182;</a>
</div>
<p>check if the frame's payload data length exceeds 2,147,483,647 (31 bits)
the maximum integer in PHP is "usually" this number. More info: <a href='http://php.net/manual/en/language.types.integer.php'>http://php.net/manual/en/language.types.integer.php</a></p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>          <span class="nv">$payloadLengthExtended32_1</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$payloadLengthExtended</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
          <span class="nv">$array</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s1">&#39;Na&#39;</span><span class="p">,</span> <span class="nv">$payloadLengthExtended32_1</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nv">$array</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="nb">ord</span><span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$payloadLengthExtended</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsSendClientClose</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_STATUS_MESSAGE_TOO_BIG</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
          <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-64" id="section-64">&#182;</a>
</div>
<p>fetch length as 32 bit unsigned integer, not as 64 bit</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>          <span class="nv">$payloadLengthExtended32_2</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$payloadLengthExtended</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
          <span class="nv">$array</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s1">&#39;Na&#39;</span><span class="p">,</span> <span class="nv">$payloadLengthExtended32_2</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-65" id="section-65">&#182;</a>
</div>
<p>check if the payload data length exceeds 2,147,479,538 (2,147,483,647 - 14 - 4095)
14 for header size, 4095 for last recv() next frame bytes</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span><span class="nv">$array</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2147479538</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsSendClientClose</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_STATUS_MESSAGE_TOO_BIG</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
          <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-66" id="section-66">&#182;</a>
</div>
<p>store frame payload data length</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>          <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$array</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-67" id="section-67">&#182;</a>
</div>
<p>check if the frame's payload data length has now been stored</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-68" id="section-68">&#182;</a>
</div>
<p>check if the frame's payload data length exceeds self::WS_MAX_FRAME_PAYLOAD_RECV</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_MAX_FRAME_PAYLOAD_RECV</span><span class="p">)</span> <span class="p">{</span>
          <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
          <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsSendClientClose</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_STATUS_MESSAGE_TOO_BIG</span><span class="p">);</span>
          <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-69" id="section-69">&#182;</a>
</div>
<p>check if the message's payload data length exceeds 2,147,483,647 or self::WS_MAX_MESSAGE_PAYLOAD_RECV
doesn't apply for control frames, where the payload data is not internally stored</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="nv">$controlFrame</span> <span class="o">=</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">9</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$controlFrame</span><span class="p">)</span> <span class="p">{</span>
          <span class="nv">$newMessagePayloadLength</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">11</span><span class="p">]</span> <span class="o">+</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">7</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="nv">$newMessagePayloadLength</span> <span class="o">&gt;</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_MAX_MESSAGE_PAYLOAD_RECV</span> <span class="o">||</span> <span class="nv">$newMessagePayloadLength</span> <span class="o">&gt;</span> <span class="mi">2147483647</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsSendClientClose</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_STATUS_MESSAGE_TOO_BIG</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">function</span> <span class="nf">wsProcessClientFrame</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-70" id="section-70">&#182;</a>
</div>
<p>store the time that data was last received from the client</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">time</span><span class="p">();</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-71" id="section-71">&#182;</a>
</div>
<p>fetch frame buffer</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$buffer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">9</span><span class="p">];</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-72" id="section-72">&#182;</a>
</div>
<p>check at least 6 bytes are set (first 2 bytes and 4 bytes for the mask key)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$buffer</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-73" id="section-73">&#182;</a>
</div>
<p>fetch first 2 bytes of header</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$octet0</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
    <span class="nv">$octet1</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>

    <span class="nv">$fin</span> <span class="o">=</span> <span class="nv">$octet0</span> <span class="o">&amp;</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_FIN</span><span class="p">;</span>
    <span class="nv">$opcode</span> <span class="o">=</span> <span class="nv">$octet0</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span>

    <span class="nv">$mask</span> <span class="o">=</span> <span class="nv">$octet1</span> <span class="o">&amp;</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_MASK</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$mask</span><span class="p">)</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span> <span class="c1">// close socket, as no mask bit was sent from the client</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-74" id="section-74">&#182;</a>
</div>
<p>fetch byte position where the mask key starts</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$seek</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">125</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">65535</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">10</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-75" id="section-75">&#182;</a>
</div>
<p>read mask key</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$maskKey</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$buffer</span><span class="p">,</span> <span class="nv">$seek</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

    <span class="nv">$array</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s1">&#39;Na&#39;</span><span class="p">,</span> <span class="nv">$maskKey</span><span class="p">);</span>
    <span class="nv">$maskKey</span> <span class="o">=</span> <span class="nv">$array</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">];</span>
    <span class="nv">$maskKey</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
      <span class="nv">$maskKey</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">,</span>
      <span class="p">(</span><span class="nv">$maskKey</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">,</span>
      <span class="p">(</span><span class="nv">$maskKey</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">,</span>
      <span class="nv">$maskKey</span> <span class="o">&amp;</span> <span class="mi">255</span>
    <span class="p">);</span>
    <span class="nv">$seek</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-76" id="section-76">&#182;</a>
</div>
<p>decode payload data</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$buffer</span><span class="p">,</span> <span class="nv">$seek</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$data</span> <span class="o">=</span> <span class="nb">str_split</span><span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$buffer</span><span class="p">,</span> <span class="nv">$seek</span><span class="p">));</span>
      <span class="k">foreach</span> <span class="p">(</span><span class="nv">$data</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$byte</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$data</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="nv">$byte</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="nv">$maskKey</span><span class="p">[</span><span class="nv">$key</span> <span class="o">%</span> <span class="mi">4</span><span class="p">]));</span>
      <span class="p">}</span>
      <span class="nv">$data</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nv">$data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-77" id="section-77">&#182;</a>
</div>
<p>check if this is not a continuation frame and if there is already data in the message buffer</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nv">$opcode</span> <span class="o">!=</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_OPCODE_CONTINUATION</span> <span class="o">&amp;&amp;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">11</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-78" id="section-78">&#182;</a>
</div>
<p>clear the message buffer</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-79" id="section-79">&#182;</a>
</div>
<p>check if the frame is marked as the final frame in the message</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nv">$fin</span> <span class="o">==</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_FIN</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-80" id="section-80">&#182;</a>
</div>
<p>check if this is the first frame in the message</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nv">$opcode</span> <span class="o">!=</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_OPCODE_CONTINUATION</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-81" id="section-81">&#182;</a>
</div>
<p>process the message</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsProcessClientMessage</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nv">$opcode</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">7</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-82" id="section-82">&#182;</a>
</div>
<p>increase message payload data length</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">11</span><span class="p">]</span> <span class="o">+=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">7</span><span class="p">];</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-83" id="section-83">&#182;</a>
</div>
<p>push frame payload data onto message buffer</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">.=</span> <span class="nv">$data</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-84" id="section-84">&#182;</a>
</div>
<p>process the message</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsProcessClientMessage</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">10</span><span class="p">],</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">11</span><span class="p">]);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-85" id="section-85">&#182;</a>
</div>
<p>check if the client wasn't removed, then reset message buffer and message opcode</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">]))</span> <span class="p">{</span>
          <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
          <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-86" id="section-86">&#182;</a>
</div>
<p>check if the frame is a control frame, control frames cannot be fragmented</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nv">$opcode</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-87" id="section-87">&#182;</a>
</div>
<p>increase message payload data length</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">11</span><span class="p">]</span> <span class="o">+=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">7</span><span class="p">];</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-88" id="section-88">&#182;</a>
</div>
<p>push frame payload data onto message buffer</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">.=</span> <span class="nv">$data</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-89" id="section-89">&#182;</a>
</div>
<p>if this is the first frame in the message, store the opcode</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nv">$opcode</span> <span class="o">!=</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_OPCODE_CONTINUATION</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$opcode</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">function</span> <span class="nf">wsProcessClientMessage</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nv">$opcode</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$data</span><span class="p">,</span> <span class="nv">$dataLength</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-90" id="section-90">&#182;</a>
</div>
<p>check opcodes</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nv">$opcode</span> <span class="o">==</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_OPCODE_PING</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-91" id="section-91">&#182;</a>
</div>
<p>received ping message</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsSendClientMessage</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_OPCODE_PONG</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">elseif</span> <span class="p">(</span><span class="nv">$opcode</span> <span class="o">==</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_OPCODE_PONG</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-92" id="section-92">&#182;</a>
</div>
<p>received pong message (it's valid if the server did not send a ping request for this pong message)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">elseif</span> <span class="p">(</span><span class="nv">$opcode</span> <span class="o">==</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_OPCODE_CLOSE</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-93" id="section-93">&#182;</a>
</div>
<p>received close message</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">substr</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$array</span> <span class="o">=</span> <span class="nb">unpack</span><span class="p">(</span><span class="s1">&#39;na&#39;</span><span class="p">,</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
        <span class="nv">$status</span> <span class="o">=</span> <span class="nv">$array</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$status</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_READY_STATE_CLOSING</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-94" id="section-94">&#182;</a>
</div>
<p>the server already sent a close frame to the client, this is the client's close frame reply
(no need to send another close frame to the client)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_READY_STATE_CLOSED</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-95" id="section-95">&#182;</a>
</div>
<p>the server has not already sent a close frame to the client, send one now</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsSendClientClose</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_STATUS_NORMAL_CLOSE</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsRemoveClient</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">elseif</span> <span class="p">(</span><span class="nv">$opcode</span> <span class="o">==</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_OPCODE_TEXT</span> <span class="o">||</span> <span class="nv">$opcode</span> <span class="o">==</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_OPCODE_BINARY</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsOnEvents</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">foreach</span> <span class="p">(</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsOnEvents</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$func</span> <span class="p">)</span>
          <span class="nv">$func</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="nv">$dataLength</span><span class="p">,</span> <span class="nv">$opcode</span> <span class="o">==</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_OPCODE_BINARY</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-96" id="section-96">&#182;</a>
</div>
<p>unknown opcode</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">function</span> <span class="nf">wsProcessClientHandshake</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$buffer</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-97" id="section-97">&#182;</a>
</div>
<p>fetch headers and request line</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$sep</span> <span class="o">=</span> <span class="nb">strpos</span><span class="p">(</span><span class="nv">$buffer</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$sep</span><span class="p">)</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span>

    <span class="nv">$headers</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$sep</span><span class="p">));</span>
    <span class="nv">$headersCount</span> <span class="o">=</span> <span class="nb">sizeof</span><span class="p">(</span><span class="nv">$headers</span><span class="p">);</span> <span class="c1">// includes request line</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$headersCount</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-98" id="section-98">&#182;</a>
</div>
<p>fetch request and check it has at least 3 parts (space tokens)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$request</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$headers</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nv">$requestParts</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nv">$request</span><span class="p">);</span>
    <span class="nv">$requestPartsSize</span> <span class="o">=</span> <span class="nb">sizeof</span><span class="p">(</span><span class="nv">$requestParts</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$requestPartsSize</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-99" id="section-99">&#182;</a>
</div>
<p>check request method is GET</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">strtoupper</span><span class="p">(</span><span class="nv">$requestParts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-100" id="section-100">&#182;</a>
</div>
<p>check request HTTP version is at least 1.1</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$httpPart</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$requestParts</span><span class="p">[</span><span class="nv">$requestPartsSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
    <span class="nv">$httpParts</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nv">$httpPart</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$httpParts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">||</span> <span class="p">(</span><span class="nx">float</span><span class="p">)</span> <span class="nv">$httpParts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.1</span><span class="p">)</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-101" id="section-101">&#182;</a>
</div>
<p>store headers into a keyed array: array[headerKey] = headerValue</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$headersKeyed</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="nv">$i</span><span class="o">&lt;</span><span class="nv">$headersCount</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$parts</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="nv">$headers</span><span class="p">[</span><span class="nv">$i</span><span class="p">]);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span>

      <span class="nv">$headersKeyed</span><span class="p">[</span><span class="nx">trim</span><span class="p">(</span><span class="nv">$parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-102" id="section-102">&#182;</a>
</div>
<p>check Host header was received</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$headersKeyed</span><span class="p">[</span><span class="s1">&#39;Host&#39;</span><span class="p">]))</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-103" id="section-103">&#182;</a>
</div>
<p>check Sec-WebSocket-Key header was received and decoded value length is 16</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$headersKeyed</span><span class="p">[</span><span class="s1">&#39;Sec-WebSocket-Key&#39;</span><span class="p">]))</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="nv">$key</span> <span class="o">=</span> <span class="nv">$headersKeyed</span><span class="p">[</span><span class="s1">&#39;Sec-WebSocket-Key&#39;</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$key</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-104" id="section-104">&#182;</a>
</div>
<p>check Sec-WebSocket-Version header was received and value is 7</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$headersKeyed</span><span class="p">[</span><span class="s1">&#39;Sec-WebSocket-Version&#39;</span><span class="p">])</span> <span class="o">||</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span> <span class="nv">$headersKeyed</span><span class="p">[</span><span class="s1">&#39;Sec-WebSocket-Version&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span> <span class="c1">// should really be != 7, but Firefox 7 beta users send 8</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-105" id="section-105">&#182;</a>
</div>
<p>work out hash to use in Sec-WebSocket-Accept reply header</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$hash</span> <span class="o">=</span> <span class="nb">base64_encode</span><span class="p">(</span><span class="nb">sha1</span><span class="p">(</span><span class="nv">$key</span><span class="o">.</span><span class="s1">&#39;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">));</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-106" id="section-106">&#182;</a>
</div>
<p>build headers</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$headers</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
      <span class="s1">&#39;HTTP/1.1 101 Switching Protocols&#39;</span><span class="p">,</span>
      <span class="s1">&#39;Upgrade: websocket&#39;</span><span class="p">,</span>
      <span class="s1">&#39;Connection: Upgrade&#39;</span><span class="p">,</span>
      <span class="s1">&#39;Sec-WebSocket-Accept: &#39;</span><span class="o">.</span><span class="nv">$hash</span>
    <span class="p">);</span>
    <span class="nv">$headers</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$headers</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\r\n\r\n</span><span class="s2">&quot;</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-107" id="section-107">&#182;</a>
</div>
<p>send headers back to client</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$socket</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>

    <span class="nv">$left</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$headers</span><span class="p">);</span>
    <span class="k">do</span> <span class="p">{</span>
      <span class="nv">$sent</span> <span class="o">=</span> <span class="o">@</span><span class="nb">socket_send</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="nv">$headers</span><span class="p">,</span> <span class="nv">$left</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$sent</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span>

      <span class="nv">$left</span> <span class="o">-=</span> <span class="nv">$sent</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">$sent</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nv">$headers</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$headers</span><span class="p">,</span> <span class="nv">$sent</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="nv">$left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
  <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-108" id="section-108">&#182;</a>
</div>
<p>client write functions</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>  <span class="k">function</span> <span class="nf">wsSendClientMessage</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nv">$opcode</span><span class="p">,</span> <span class="nv">$message</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-109" id="section-109">&#182;</a>
</div>
<p>check if client ready state is already closing or closed</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_READY_STATE_CLOSING</span> <span class="o">||</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_READY_STATE_CLOSED</span><span class="p">)</span> <span class="k">return</span> <span class="k">true</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-110" id="section-110">&#182;</a>
</div>
<p>fetch message length</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$messageLength</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-111" id="section-111">&#182;</a>
</div>
<p>set max payload length per frame</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$bufferSize</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-112" id="section-112">&#182;</a>
</div>
<p>work out amount of frames to send, based on $bufferSize</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$frameCount</span> <span class="o">=</span> <span class="nb">ceil</span><span class="p">(</span><span class="nv">$messageLength</span> <span class="o">/</span> <span class="nv">$bufferSize</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$frameCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nv">$frameCount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-113" id="section-113">&#182;</a>
</div>
<p>set last frame variables</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$maxFrame</span> <span class="o">=</span> <span class="nv">$frameCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nv">$lastFrameBufferLength</span> <span class="o">=</span> <span class="p">(</span><span class="nv">$messageLength</span> <span class="o">%</span> <span class="nv">$bufferSize</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="p">(</span><span class="nv">$messageLength</span> <span class="o">%</span> <span class="nv">$bufferSize</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="nv">$messageLength</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="nv">$bufferSize</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-114" id="section-114">&#182;</a>
</div>
<p>loop around all frames to send</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span><span class="o">&lt;</span><span class="nv">$frameCount</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-115" id="section-115">&#182;</a>
</div>
<p>fetch fin, opcode and buffer length for frame</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="nv">$fin</span> <span class="o">=</span> <span class="nv">$i</span> <span class="o">!=</span> <span class="nv">$maxFrame</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_FIN</span><span class="p">;</span>
      <span class="nv">$opcode</span> <span class="o">=</span> <span class="nv">$i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_OPCODE_CONTINUATION</span> <span class="o">:</span> <span class="nv">$opcode</span><span class="p">;</span>

      <span class="nv">$bufferLength</span> <span class="o">=</span> <span class="nv">$i</span> <span class="o">!=</span> <span class="nv">$maxFrame</span> <span class="o">?</span> <span class="nv">$bufferSize</span> <span class="o">:</span> <span class="nv">$lastFrameBufferLength</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-116" id="section-116">&#182;</a>
</div>
<p>set payload length variables for frame</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nv">$bufferLength</span> <span class="o">&lt;=</span> <span class="mi">125</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$payloadLength</span> <span class="o">=</span> <span class="nv">$bufferLength</span><span class="p">;</span>
        <span class="nv">$payloadLengthExtended</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="nv">$payloadLengthExtendedLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">elseif</span> <span class="p">(</span><span class="nv">$bufferLength</span> <span class="o">&lt;=</span> <span class="mi">65535</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$payloadLength</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_PAYLOAD_LENGTH_16</span><span class="p">;</span>
        <span class="nv">$payloadLengthExtended</span> <span class="o">=</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="nv">$bufferLength</span><span class="p">);</span>
        <span class="nv">$payloadLengthExtendedLength</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$payloadLength</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_PAYLOAD_LENGTH_63</span><span class="p">;</span>
        <span class="nv">$payloadLengthExtended</span> <span class="o">=</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">&#39;xxxxN&#39;</span><span class="p">,</span> <span class="nv">$bufferLength</span><span class="p">);</span> <span class="c1">// pack 32 bit int, should really be 64 bit int</span>
        <span class="nv">$payloadLengthExtendedLength</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
      <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-117" id="section-117">&#182;</a>
</div>
<p>set frame bytes</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="nv">$buffer</span> <span class="o">=</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="p">((</span><span class="nv">$fin</span> <span class="o">|</span> <span class="nv">$opcode</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="nv">$payloadLength</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$payloadLengthExtended</span> <span class="o">.</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$message</span><span class="p">,</span> <span class="nv">$i</span><span class="o">*</span><span class="nv">$bufferSize</span><span class="p">,</span> <span class="nv">$bufferLength</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-118" id="section-118">&#182;</a>
</div>
<p>send frame</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>      <span class="nv">$socket</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>

      <span class="nv">$left</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="nv">$payloadLengthExtendedLength</span> <span class="o">+</span> <span class="nv">$bufferLength</span><span class="p">;</span>
      <span class="k">do</span> <span class="p">{</span>
        <span class="nv">$sent</span> <span class="o">=</span> <span class="o">@</span><span class="nb">socket_send</span><span class="p">(</span><span class="nv">$socket</span><span class="p">,</span> <span class="nv">$buffer</span><span class="p">,</span> <span class="nv">$left</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$sent</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span>

        <span class="nv">$left</span> <span class="o">-=</span> <span class="nv">$sent</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$sent</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nv">$buffer</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$buffer</span><span class="p">,</span> <span class="nv">$sent</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">while</span> <span class="p">(</span><span class="nv">$left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">function</span> <span class="nf">wsSendClientClose</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nv">$status</span><span class="o">=</span><span class="k">false</span><span class="p">)</span> <span class="p">{</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-119" id="section-119">&#182;</a>
</div>
<p>check if client ready state is already closing or closed</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_READY_STATE_CLOSING</span> <span class="o">||</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_READY_STATE_CLOSED</span><span class="p">)</span> <span class="k">return</span> <span class="k">true</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-120" id="section-120">&#182;</a>
</div>
<p>store close status</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$status</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-121" id="section-121">&#182;</a>
</div>
<p>send close frame to client</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$status</span> <span class="o">=</span> <span class="nv">$status</span> <span class="o">!==</span> <span class="k">false</span> <span class="o">?</span> <span class="nb">pack</span><span class="p">(</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="nv">$status</span><span class="p">)</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsSendClientMessage</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_OPCODE_CLOSE</span><span class="p">,</span> <span class="nv">$status</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-122" id="section-122">&#182;</a>
</div>
<p>set client ready state to closing</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsClients</span><span class="p">[</span><span class="nv">$clientID</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_READY_STATE_CLOSING</span><span class="p">;</span>
  <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-123" id="section-123">&#182;</a>
</div>
<p>client non-internal functions</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>  <span class="k">function</span> <span class="nf">wsClose</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsSendClientClose</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_STATUS_NORMAL_CLOSE</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">function</span> <span class="nf">wsSend</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nv">$message</span><span class="p">,</span> <span class="nv">$binary</span><span class="o">=</span><span class="k">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsSendClientMessage</span><span class="p">(</span><span class="nv">$clientID</span><span class="p">,</span> <span class="nv">$binary</span> <span class="o">?</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_OPCODE_BINARY</span> <span class="o">:</span> <span class="nx">self</span><span class="o">::</span><span class="na">WS_OPCODE_TEXT</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">function</span> <span class="nf">log</span><span class="p">(</span> <span class="nv">$message</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">echo</span> <span class="nb">date</span><span class="p">(</span><span class="s1">&#39;Y-m-d H:i:s: &#39;</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$message</span> <span class="o">.</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">function</span> <span class="nf">bind</span><span class="p">(</span> <span class="nv">$type</span><span class="p">,</span> <span class="nv">$func</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsOnEvents</span><span class="p">[</span><span class="nv">$type</span><span class="p">])</span> <span class="p">)</span>
      <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsOnEvents</span><span class="p">[</span><span class="nv">$type</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsOnEvents</span><span class="p">[</span><span class="nv">$type</span><span class="p">][]</span> <span class="o">=</span> <span class="nv">$func</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">function</span> <span class="nf">unbind</span><span class="p">(</span> <span class="nv">$type</span><span class="o">=</span><span class="s1">&#39;&#39;</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="nv">$type</span> <span class="p">)</span> <span class="nb">unset</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsOnEvents</span><span class="p">[</span><span class="nv">$type</span><span class="p">]);</span>
    <span class="k">else</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">wsOnEvents</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
