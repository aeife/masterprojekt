<!DOCTYPE html>
<html>
<head>
  <title>server.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="doc-style.css" />
  <script src="doc-filelist.js"></script>
  <script>
    var relativeDir = '', thisFile = 'server.js', defaultSidebar = true;
  </script>
  <script src="doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#server.js">server.js</a>
      </div>
      <div class="heading h2">
        <a href="#io.sockets.on--connection--">io.sockets.on('connection')</a>
      </div>
      <div class="heading h2">
        <a href="#socket.on--startgame--">socket.on('startGame')</a>
      </div>
      <div class="heading h2">
        <a href="#socket.on--getnewfoodcoordinates--">socket.on('getNewFoodCoordinates')</a>
      </div>
      <div class="heading h2">
        <a href="#socket.on--getmoveplayers--">socket.on('getMovePlayers')</a>
      </div>
      <div class="heading h2">
        <a href="#socket.on--newdirection--">socket.on('newDirection')</a>
      </div>
      <div class="heading h2">
        <a href="#socket.on--newname--">socket.on('newName')</a>
      </div>
      <div class="heading h2">
        <a href="#socket.on--dead--">socket.on('dead')</a>
      </div>
      <div class="heading h2">
        <a href="#socket.on--disconnect--">socket.on('disconnect')</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="server.js">
  <h1>
    <a href="#server.js" class="pilcrow">&#182;</a>
    server.js
  </h1>
</div>

  </div>
  <div class="body"><p>Serverseitige Umsetzung mittels node.js
Enthält Webserver mittels Express und Socket-Server mittels socket.io</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>Definition von Modulabhängigkeiten (siehe auch package.json)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">routes</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/user&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">login</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/login&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">logout</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/logout&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">register</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/register&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">score</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/score&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">game</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/game&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">impressum</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./routes/impressum&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">)</span>
    <span class="p">,</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>Initialisierung einer Express-Applikation</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>Konfiguration</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span> <span class="o">||</span> <span class="mi">3000</span><span class="p">);</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;views&#39;</span><span class="p">,</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/views&#39;</span><span class="p">);</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;view engine&#39;</span><span class="p">,</span> <span class="s1">&#39;jade&#39;</span><span class="p">);</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">favicon</span><span class="p">());</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">logger</span><span class="p">(</span><span class="s1">&#39;dev&#39;</span><span class="p">));</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">());</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">methodOverride</span><span class="p">());</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">cookieParser</span><span class="p">(</span><span class="s1">&#39;your secret here&#39;</span><span class="p">));</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">session</span><span class="p">());</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">router</span><span class="p">);</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;public&#39;</span><span class="p">)));</span>
<span class="p">});</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>Konfiguration für Entwicklungsbetrieb</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="s1">&#39;development&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">errorHandler</span><span class="p">());</span>
<span class="p">});</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>Definition von Routen</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">routes</span><span class="p">.</span><span class="nx">index</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/game&#39;</span><span class="p">,</span> <span class="nx">game</span><span class="p">.</span><span class="nx">game</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/users&#39;</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nx">list</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="nx">login</span><span class="p">.</span><span class="nx">form</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="nx">login</span><span class="p">.</span><span class="nx">auth</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/logout&#39;</span><span class="p">,</span> <span class="nx">logout</span><span class="p">.</span><span class="nx">logout</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/register&#39;</span><span class="p">,</span> <span class="nx">register</span><span class="p">.</span><span class="nx">form</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/register&#39;</span><span class="p">,</span> <span class="nx">register</span><span class="p">.</span><span class="nx">register</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/score&#39;</span><span class="p">,</span> <span class="nx">score</span><span class="p">.</span><span class="nx">list</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/score/players&#39;</span><span class="p">,</span> <span class="nx">score</span><span class="p">.</span><span class="nx">players</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/score/:id&#39;</span><span class="p">,</span> <span class="nx">score</span><span class="p">.</span><span class="nx">details</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/impressum&#39;</span><span class="p">,</span> <span class="nx">impressum</span><span class="p">.</span><span class="nx">impressum</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>Initialisierung des Webservers</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">),</span> <span class="s1">&#39;192.168.1.196&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Express server listening on port &quot;</span> <span class="o">+</span> <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">));</span>
<span class="p">});</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>Initialisierung des Socket-Servers</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">io</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io&#39;</span><span class="p">).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">server</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>Initialisierung von globalen Variablen</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">players</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">var</span> <span class="nx">gridSize</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">spawns</span> <span class="o">=</span> <span class="p">[];</span>
<span class="nx">spawns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">gridSize</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">direction</span><span class="o">:</span> <span class="s2">&quot;east&quot;</span><span class="p">};</span>
<span class="nx">spawns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="nx">gridSize</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">gridSize</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">direction</span><span class="o">:</span> <span class="s2">&quot;west&quot;</span><span class="p">};</span>
<span class="nx">spawns</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="nx">gridSize</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nx">direction</span><span class="o">:</span> <span class="s2">&quot;south&quot;</span><span class="p">};</span>
<span class="nx">spawns</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="nx">gridSize</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">gridSize</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="nx">direction</span><span class="o">:</span> <span class="s2">&quot;north&quot;</span><span class="p">};</span>
<span class="kd">var</span> <span class="nx">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;pink&#39;</span><span class="p">];</span>
<span class="kd">var</span> <span class="nx">places</span> <span class="o">=</span> <span class="p">[];</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="io.sockets.on--connection--">
  <h2>
    <a href="#io.sockets.on--connection--" class="pilcrow">&#182;</a>
    io.sockets.on('connection')
  </h2>
</div>

  </div>
  <div class="body"><p>Handhabung der Socketverbindungen ab Connection-Event</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">socket</span>
      <span class="dox_type">object</span>
      <span>Datenobjekt der Callback-Funktion zur Handhabung eingegangener Socketverbindungen</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">){</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>ID des gerade verbundenen Clients</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">clientId</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>Daten für neuen Client</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">spawn</span> <span class="o">=</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="nx">spawns</span><span class="p">[</span><span class="nx">players</span><span class="p">.</span><span class="nx">length</span><span class="p">].</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">spawns</span><span class="p">[</span><span class="nx">players</span><span class="p">.</span><span class="nx">length</span><span class="p">].</span><span class="nx">y</span><span class="p">,</span> <span class="nx">direction</span><span class="o">:</span> <span class="nx">spawns</span><span class="p">[</span><span class="nx">players</span><span class="p">.</span><span class="nx">length</span><span class="p">].</span><span class="nx">direction</span><span class="p">};</span>
    <span class="kd">var</span> <span class="nx">color</span> <span class="o">=</span> <span class="nx">colors</span><span class="p">[</span><span class="nx">players</span><span class="p">.</span><span class="nx">length</span><span class="p">];</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>Der 1. verbundene Client übernimmt die Rolle des Hosts.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">players</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span>
        <span class="kd">var</span> <span class="nx">host</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">else</span> 
        <span class="kd">var</span> <span class="nx">host</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="nx">players</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">clientId</span><span class="o">:</span> <span class="nx">clientId</span><span class="p">,</span> <span class="nx">spawn</span><span class="o">:</span> <span class="nx">spawn</span><span class="p">,</span> <span class="nx">host</span><span class="o">:</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">color</span><span class="o">:</span> <span class="nx">color</span><span class="p">,</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;Guest&#39;</span><span class="p">});</span>

    
    <span class="kd">var</span> <span class="nx">connectionData</span> <span class="o">=</span> <span class="p">{</span><span class="nx">clientId</span><span class="o">:</span> <span class="nx">clientId</span><span class="p">,</span> <span class="nx">players</span><span class="o">:</span> <span class="nx">players</span><span class="p">,</span> <span class="nx">spawn</span><span class="o">:</span> <span class="nx">spawn</span><span class="p">,</span> <span class="nx">gridSize</span><span class="o">:</span> <span class="nx">gridSize</span><span class="p">};</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>Übermittlung der eigenen Daten an den Client </p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;successfulConnected&#39;</span><span class="p">,</span> <span class="nx">connectionData</span><span class="p">);</span> </pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="socket.on--startgame--">
  <h2>
    <a href="#socket.on--startgame--" class="pilcrow">&#182;</a>
    socket.on('startGame')
  </h2>
</div>

  </div>
  <div class="body"><p>Startet das Spiel und übermittelt Startinformation an alle Spieler</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;startGame&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;playerStartedGame&#39;</span><span class="p">);</span>

        <span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
            <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="nx">gridSize</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
            <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="nx">gridSize</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>

            <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;newFoodCoordinates&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">y</span><span class="p">});</span> 
        <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>

        <span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
            <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;movePlayers&#39;</span><span class="p">);</span> 
        <span class="p">},</span> <span class="mi">50</span><span class="p">);</span>


    <span class="p">});</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="socket.on--getnewfoodcoordinates--">
  <h2>
    <a href="#socket.on--getnewfoodcoordinates--" class="pilcrow">&#182;</a>
    socket.on('getNewFoodCoordinates')
  </h2>
</div>

  </div>
  <div class="body"><p>Erzeugen und Übermitteln (an alle Spieler) neuer Futter-Koordinaten</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;getNewFoodCoordinates&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="nx">gridSize</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
        <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="nx">gridSize</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>

        <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;newFoodCoordinates&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">y</span><span class="p">});</span>
    <span class="p">});</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="socket.on--getmoveplayers--">
  <h2>
    <a href="#socket.on--getmoveplayers--" class="pilcrow">&#182;</a>
    socket.on('getMovePlayers')
  </h2>
</div>

  </div>
  <div class="body"><p>Server hat Bewegungsbefehl von Host erhalten und übermittelt dies an alle Spieler</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;getMovePlayers&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
        <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;movePlayers&#39;</span><span class="p">);</span> 
    <span class="p">});</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="socket.on--newdirection--">
  <h2>
    <a href="#socket.on--newdirection--" class="pilcrow">&#182;</a>
    socket.on('newDirection')
  </h2>
</div>

  </div>
  <div class="body"><p>Spieler hat Richtungsänderung gesendet
Weiterleitung der Information an alle Clients</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">data</span>
      <span class="dox_type">object</span>
      <span>Datenobjekt der Callback-Funktion mit Informationen zum Client und dessen Richtungsänderung</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;newDirection&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;NEW DIRECTION FROM: &quot;</span> <span class="o">+</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;playerSentNewDirection&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">clientId</span><span class="o">:</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">direction</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">direction</span><span class="p">});</span>
    <span class="p">});</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="socket.on--newname--">
  <h2>
    <a href="#socket.on--newname--" class="pilcrow">&#182;</a>
    socket.on('newName')
  </h2>
</div>

  </div>
  <div class="body"><p>Erst wenn ein neuer Client seinen Nutzernamen gesendet hat, werden seine Verbindungsinformationen an alle anderen Spieler gesendet.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">data</span>
      <span class="dox_type">object</span>
      <span>Datenobjekt der Callback-Funktion mit Nutzername des Clients</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;newName&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;NEW NAME FROM: &quot;</span> <span class="o">+</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">players</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">players</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">clientId</span> <span class="o">===</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">){</span>
                <span class="nx">players</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">username</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">username</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">spawn</span> <span class="o">=</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="nx">spawns</span><span class="p">[</span><span class="nx">players</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">spawns</span><span class="p">[</span><span class="nx">players</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">y</span><span class="p">,</span> <span class="nx">direction</span><span class="o">:</span> <span class="nx">spawns</span><span class="p">[</span><span class="nx">players</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">direction</span><span class="p">};</span>
        <span class="kd">var</span> <span class="nx">color</span> <span class="o">=</span> <span class="nx">colors</span><span class="p">[</span><span class="nx">players</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>

        <span class="nx">socket</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;newPlayerConnected&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">clientId</span><span class="o">:</span> <span class="nx">clientId</span><span class="p">,</span> <span class="nx">spawn</span><span class="o">:</span> <span class="nx">spawn</span><span class="p">,</span> <span class="nx">color</span><span class="o">:</span> <span class="nx">color</span><span class="p">,</span> <span class="nx">username</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">username</span><span class="p">});</span>
    <span class="p">});</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="socket.on--dead--">
  <h2>
    <a href="#socket.on--dead--" class="pilcrow">&#182;</a>
    socket.on('dead')
  </h2>
</div>

  </div>
  <div class="body"><p>Spieler sendet seinen Tod an den Server</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">data</span>
      <span class="dox_type">object</span>
      <span>Datenobjekt der Callback-Funktion mit allen Informationen des gestorbenen Clients</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;dead&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
        <span class="nx">places</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">username</span><span class="p">);</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>Prüfe, ob das Spiel beendet ist
Beendigungsbedingung: nur noch ein lebender Spieler</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">places</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="nx">players</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">){</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;GAME OVER&quot;</span><span class="p">);</span>
            
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">players</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
                <span class="kd">var</span> <span class="nx">isDead</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">places</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">){</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">players</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">username</span> <span class="o">===</span> <span class="nx">places</span><span class="p">[</span><span class="nx">j</span><span class="p">]){</span>
                        <span class="nx">isDead</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isDead</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">places</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">players</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">username</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">places</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="nx">players</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span>
                <span class="nx">places</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;Guest&quot;</span><span class="p">);</span>
            <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>Aufbau der Datenbankverbindung</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>            <span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./database.js&#39;</span><span class="p">);</span>

            <span class="nx">db</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>

                <span class="kd">var</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="s1">&#39;game&#39;</span><span class="p">);</span>
                <span class="kd">var</span> <span class="nx">newGameId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>Finden der nächsten Spiel-ID
Einfügen des Endstands des aktuellen Spiels unter neuer Spiel-ID</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>                <span class="nx">collection</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({},</span> <span class="p">{</span><span class="s1">&#39;sort&#39;</span><span class="o">:</span> <span class="p">{</span><span class="nx">id</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}}</span> <span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">games</span><span class="p">){</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
                    
                    <span class="k">if</span> <span class="p">(</span><span class="nx">games</span><span class="p">){</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">games</span><span class="p">);</span>
                        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">places</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
                            <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="nx">id</span><span class="o">:</span> <span class="nx">games</span><span class="p">.</span><span class="nx">id</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nx">username</span><span class="o">:</span> <span class="nx">places</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">place</span><span class="o">:</span> <span class="nx">places</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="nx">i</span><span class="p">},</span> <span class="p">{</span><span class="nx">w</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
                            <span class="p">});</span>
                        <span class="p">}</span>
                    <span class="p">}</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>Übermittlung des Spielendes an alle Spieler</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>                <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;gameOver&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">gameId</span><span class="o">:</span> <span class="nx">games</span><span class="p">.</span><span class="nx">id</span><span class="o">+</span><span class="mi">1</span><span class="p">});</span>

                <span class="p">});</span>

            <span class="p">});</span>

            
        <span class="p">}</span>

        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">places</span><span class="p">);</span>
    <span class="p">});</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="socket.on--disconnect--">
  <h2>
    <a href="#socket.on--disconnect--" class="pilcrow">&#182;</a>
    socket.on('disconnect')
  </h2>
</div>

  </div>
  <div class="body"><p>Verbindung zu einem Spieler ist abgebrochen</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">data</span>
      <span class="dox_type">object</span>
      <span>Datenobjekt der Callback-Funktion mit Informationen zum Client, welcher die Verbindung abgebrochen hat</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;disconnect&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>Übermittlung, dass ein Client das Spiel verlassen hat, an alle anderen Spieler</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="nx">socket</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;playerDisconnected&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">clientId</span><span class="o">:</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">});</span></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>Entfernen des Spielers aus dem allgemeinen Spielerfeld</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">players</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">players</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">clientId</span> <span class="o">===</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="nx">players</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">players</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">players</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">client</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">});</span>

    

<span class="p">});</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
